{"file_name": "/home/qj213/afp-2021-10-22/thys/KD_Tree/Nearest_Neighbors.thy", "working_directory": "/home/qj213/afp-2021-10-22/thys/KD_Tree", "problem_names": ["lemma\n  assumes \"sorted_wrt f xs\"\n  shows sorted_wrt_take: \"sorted_wrt f (take n xs)\"\n  and sorted_wrt_drop: \"sorted_wrt f (drop n xs)\"", "lemma sorted_wrt_dist_insort_key:\n  \"sorted_wrt_dist p ps \\<Longrightarrow> sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\"", "lemma sorted_wrt_dist_take_drop:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"\\<forall>p\\<^sub>0 \\<in> set (take n ps). \\<forall>p\\<^sub>1 \\<in> set (drop n ps). dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p\"", "lemma sorted_wrt_dist_last_take_mono:\n  assumes \"sorted_wrt_dist p ps\" \"n \\<le> length ps\" \"0 < n\"\n  shows \"dist (last (take n ps)) p \\<le> dist (last ps) p\"", "lemma sorted_wrt_dist_last_insort_key_eq:\n  assumes \"sorted_wrt_dist p ps\" \"insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\"\n  shows \"last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\"", "lemma sorted_wrt_dist_last:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"\\<forall>q \\<in> set ps. dist q p \\<le> dist (last ps) p\"", "lemma sorted_wrt_dist_nbors:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"sorted_wrt_dist p (upd_nbors n p q ps)\"", "lemma sorted_wrt_dist_nbors_diff:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"\\<forall>r \\<in> set ps \\<union> {q} - set (upd_nbors n p q ps). \\<forall>s \\<in> set (upd_nbors n p q ps). dist s p \\<le> dist r p\"", "lemma sorted_wrt_dist_last_upd_nbors_mono:\n  assumes \"sorted_wrt_dist p ps\" \"n \\<le> length ps\" \"0 < n\"\n  shows \"dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p\"", "lemma cutoff_r:\n  assumes \"invar (Node k v l r)\"\n  assumes \"p$k \\<le> v\" \"dist p c \\<le> dist (p$k) v\"\n  shows \"\\<forall>q \\<in> set_kdt r. dist p c \\<le> dist p q\"", "lemma cutoff_l:\n  assumes \"invar (Node k v l r)\"\n  assumes \"v \\<le> p$k\" \"dist p c \\<le> dist v (p$k)\"\n  shows \"\\<forall>q \\<in> set_kdt l. dist p c \\<le> dist p q\"", "lemma set_nns:\n  \"set (nearest_nbors n ps p kdt) \\<subseteq> set_kdt kdt \\<union> set ps\"", "lemma length_nns:\n  \"length (nearest_nbors n ps p kdt) = min n (size_kdt kdt + length ps)\"", "lemma length_nns_gt_0:\n  \"0 < n \\<Longrightarrow> 0 < length (nearest_nbors n ps p kdt)\"", "lemma length_nns_n:\n  assumes \"(set_kdt kdt \\<union> set ps) - set (nearest_nbors n ps p kdt) \\<noteq> {}\"\n  shows \"length (nearest_nbors n ps p kdt) = n\"", "lemma sorted_nns:\n  \"sorted_wrt_dist p ps \\<Longrightarrow> sorted_wrt_dist p (nearest_nbors n ps p kdt)\"", "lemma distinct_nns:\n  assumes \"invar kdt\" \"distinct ps\" \"set ps \\<inter> set_kdt kdt = {}\"\n  shows \"distinct (nearest_nbors n ps p kdt)\"", "lemma last_nns_mono:\n  assumes \"invar kdt\" \"sorted_wrt_dist p ps\" \"n \\<le> length ps\" \"0 < n\"\n  shows \"dist (last (nearest_nbors n ps p kdt)) p \\<le> dist (last ps) p\"", "theorem dist_nns:\n  assumes \"invar kdt\" \"sorted_wrt_dist p ps\" \"set ps \\<inter> set_kdt kdt = {}\" \"distinct ps\" \"0 < n\"\n  shows \"\\<forall>q \\<in> set_kdt kdt \\<union> set ps - set (nearest_nbors n ps p kdt). dist (last (nearest_nbors n ps p kdt)) p \\<le> dist q p\"", "theorem length_nearest_neighbors:\n  \"length (nearest_neighbors n p kdt) = min n (size_kdt kdt)\"", "theorem sorted_wrt_dist_nearest_neighbors:\n  \"sorted_wrt_dist p (nearest_neighbors n p kdt)\"", "theorem set_nearest_neighbors:\n  \"set (nearest_neighbors n p kdt) \\<subseteq> set_kdt kdt\"", "theorem distinct_nearest_neighbors:\n  assumes \"invar kdt\"\n  shows \"distinct (nearest_neighbors n p kdt)\"", "theorem dist_nearest_neighbors:\n  assumes \"invar kdt\" \"nns = nearest_neighbors n p kdt\"\n  shows \"\\<forall>q \\<in> (set_kdt kdt - set nns). \\<forall>r \\<in> set nns. dist r p \\<le> dist q p\""], "translations": [["", "lemma\n  assumes \"sorted_wrt f xs\"\n  shows sorted_wrt_take: \"sorted_wrt f (take n xs)\"\n  and sorted_wrt_drop: \"sorted_wrt f (drop n xs)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt f (take n xs) &&& sorted_wrt f (drop n xs)", "proof -"], ["proof (state)\ngoal (2 subgoals):\n 1. sorted_wrt f (take n xs)\n 2. sorted_wrt f (drop n xs)", "have \"sorted_wrt f (take n xs @ drop n xs)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt f (take n xs @ drop n xs)", "using assms"], ["proof (prove)\nusing this:\n  sorted_wrt f xs\n\ngoal (1 subgoal):\n 1. sorted_wrt f (take n xs @ drop n xs)", "by simp"], ["proof (state)\nthis:\n  sorted_wrt f (take n xs @ drop n xs)\n\ngoal (2 subgoals):\n 1. sorted_wrt f (take n xs)\n 2. sorted_wrt f (drop n xs)", "thus \"sorted_wrt f (take n xs)\" \"sorted_wrt f (drop n xs)\""], ["proof (prove)\nusing this:\n  sorted_wrt f (take n xs @ drop n xs)\n\ngoal (1 subgoal):\n 1. sorted_wrt f (take n xs) &&& sorted_wrt f (drop n xs)", "using sorted_wrt_append"], ["proof (prove)\nusing this:\n  sorted_wrt f (take n xs @ drop n xs)\n  sorted_wrt ?P (?xs @ ?ys) =\n  (sorted_wrt ?P ?xs \\<and>\n   sorted_wrt ?P ?ys \\<and>\n   (\\<forall>x\\<in>set ?xs. \\<forall>y\\<in>set ?ys. ?P x y))\n\ngoal (1 subgoal):\n 1. sorted_wrt f (take n xs) &&& sorted_wrt f (drop n xs)", "by blast+"], ["proof (state)\nthis:\n  sorted_wrt f (take n xs)\n  sorted_wrt f (drop n xs)\n\ngoal:\nNo subgoals!", "qed"], ["", "definition sorted_wrt_dist :: \"('k::finite) point \\<Rightarrow> 'k point list \\<Rightarrow> bool\" where\n  \"sorted_wrt_dist p \\<equiv> sorted_wrt (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p)\""], ["", "lemma sorted_wrt_dist_insort_key:\n  \"sorted_wrt_dist p ps \\<Longrightarrow> sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p ps \\<Longrightarrow>\n    sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)", "by (induction ps) (auto simp: sorted_wrt_dist_def set_insort_key)"], ["", "lemma sorted_wrt_dist_take_drop:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"\\<forall>p\\<^sub>0 \\<in> set (take n ps). \\<forall>p\\<^sub>1 \\<in> set (drop n ps). dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>p\\<^sub>0\\<in>set (take n ps).\n       \\<forall>p\\<^sub>1\\<in>set (drop n ps).\n          dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p", "using assms sorted_wrt_append[of _ \"take n ps\" \"drop n ps\"]"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p ps\n  sorted_wrt ?P (take n ps @ drop n ps) =\n  (sorted_wrt ?P (take n ps) \\<and>\n   sorted_wrt ?P (drop n ps) \\<and>\n   (\\<forall>x\\<in>set (take n ps). \\<forall>y\\<in>set (drop n ps). ?P x y))\n\ngoal (1 subgoal):\n 1. \\<forall>p\\<^sub>0\\<in>set (take n ps).\n       \\<forall>p\\<^sub>1\\<in>set (drop n ps).\n          dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p", "by (simp add: sorted_wrt_dist_def)"], ["", "lemma sorted_wrt_dist_last_take_mono:\n  assumes \"sorted_wrt_dist p ps\" \"n \\<le> length ps\" \"0 < n\"\n  shows \"dist (last (take n ps)) p \\<le> dist (last ps) p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (take n ps)) p \\<le> dist (last ps) p", "using assms"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (take n ps)) p \\<le> dist (last ps) p", "unfolding sorted_wrt_dist_def"], ["proof (prove)\nusing this:\n  sorted_wrt\n   (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p)\n   ps\n  n \\<le> length ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (take n ps)) p \\<le> dist (last ps) p", "by (induction ps arbitrary: n) (auto simp add: take_Cons')"], ["", "lemma sorted_wrt_dist_last_insort_key_eq:\n  assumes \"sorted_wrt_dist p ps\" \"insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\"\n  shows \"last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\""], ["proof (prove)\ngoal (1 subgoal):\n 1. last (insort_key (\\<lambda>q. dist q p) q ps) = last ps", "using assms"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p ps\n  insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\n\ngoal (1 subgoal):\n 1. last (insort_key (\\<lambda>q. dist q p) q ps) = last ps", "unfolding sorted_wrt_dist_def"], ["proof (prove)\nusing this:\n  sorted_wrt\n   (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p)\n   ps\n  insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\n\ngoal (1 subgoal):\n 1. last (insort_key (\\<lambda>q. dist q p) q ps) = last ps", "by (induction ps) (auto)"], ["", "lemma sorted_wrt_dist_last:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"\\<forall>q \\<in> set ps. dist q p \\<le> dist (last ps) p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "proof (cases \"ps = []\")"], ["proof (state)\ngoal (2 subgoals):\n 1. ps = [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p\n 2. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "case True"], ["proof (state)\nthis:\n  ps = []\n\ngoal (2 subgoals):\n 1. ps = [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p\n 2. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "thus ?thesis"], ["proof (prove)\nusing this:\n  ps = []\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "by simp"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p\n\ngoal (1 subgoal):\n 1. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "next"], ["proof (state)\ngoal (1 subgoal):\n 1. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "case False"], ["proof (state)\nthis:\n  ps \\<noteq> []\n\ngoal (1 subgoal):\n 1. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "then"], ["proof (chain)\npicking this:\n  ps \\<noteq> []", "obtain ps' p' where [simp]:\"ps = ps' @ [p']\""], ["proof (prove)\nusing this:\n  ps \\<noteq> []\n\ngoal (1 subgoal):\n 1. (\\<And>ps' p'.\n        ps = ps' @ [p'] \\<Longrightarrow> thesis) \\<Longrightarrow>\n    thesis", "using rev_exhaust"], ["proof (prove)\nusing this:\n  ps \\<noteq> []\n  \\<lbrakk>?xs = [] \\<Longrightarrow> ?P;\n   \\<And>ys y. ?xs = ys @ [y] \\<Longrightarrow> ?P\\<rbrakk>\n  \\<Longrightarrow> ?P\n\ngoal (1 subgoal):\n 1. (\\<And>ps' p'.\n        ps = ps' @ [p'] \\<Longrightarrow> thesis) \\<Longrightarrow>\n    thesis", "by blast"], ["proof (state)\nthis:\n  ps = ps' @ [p']\n\ngoal (1 subgoal):\n 1. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "hence \"sorted_wrt_dist p (ps' @ [p'])\""], ["proof (prove)\nusing this:\n  ps = ps' @ [p']\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (ps' @ [p'])", "using assms"], ["proof (prove)\nusing this:\n  ps = ps' @ [p']\n  sorted_wrt_dist p ps\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (ps' @ [p'])", "by blast"], ["proof (state)\nthis:\n  sorted_wrt_dist p (ps' @ [p'])\n\ngoal (1 subgoal):\n 1. ps \\<noteq> [] \\<Longrightarrow>\n    \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "thus ?thesis"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p (ps' @ [p'])\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "unfolding sorted_wrt_dist_def"], ["proof (prove)\nusing this:\n  sorted_wrt\n   (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p)\n   (ps' @ [p'])\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "using sorted_wrt_append[of _ ps' \"[p']\"]"], ["proof (prove)\nusing this:\n  sorted_wrt\n   (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p)\n   (ps' @ [p'])\n  sorted_wrt ?P (ps' @ [p']) =\n  (sorted_wrt ?P ps' \\<and>\n   sorted_wrt ?P [p'] \\<and>\n   (\\<forall>x\\<in>set ps'. \\<forall>y\\<in>set [p']. ?P x y))\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p", "by simp"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set ps. dist q p \\<le> dist (last ps) p\n\ngoal:\nNo subgoals!", "qed"], ["", "subsection \\<open>Neighbors Sorted wrt. Distance\\<close>"], ["", "definition upd_nbors :: \"nat \\<Rightarrow> ('k::finite) point \\<Rightarrow> 'k point \\<Rightarrow> 'k point list \\<Rightarrow> 'k point list\" where\n  \"upd_nbors n p q ps = take n (insort_key (\\<lambda>q. dist q p) q ps)\""], ["", "lemma sorted_wrt_dist_nbors:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"sorted_wrt_dist p (upd_nbors n p q ps)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (upd_nbors n p q ps)", "proof -"], ["proof (state)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (upd_nbors n p q ps)", "have \"sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)", "using assms sorted_wrt_dist_insort_key"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p ps\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (insort_key (\\<lambda>q. dist q ?p) ?q ?ps)\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)", "by blast"], ["proof (state)\nthis:\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (upd_nbors n p q ps)", "thus ?thesis"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (upd_nbors n p q ps)", "by (simp add: sorted_wrt_dist_def sorted_wrt_take upd_nbors_def)"], ["proof (state)\nthis:\n  sorted_wrt_dist p (upd_nbors n p q ps)\n\ngoal:\nNo subgoals!", "qed"], ["", "lemma sorted_wrt_dist_nbors_diff:\n  assumes \"sorted_wrt_dist p ps\"\n  shows \"\\<forall>r \\<in> set ps \\<union> {q} - set (upd_nbors n p q ps). \\<forall>s \\<in> set (upd_nbors n p q ps). dist s p \\<le> dist r p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "proof -"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "let ?ps' = \"insort_key (\\<lambda>q. dist q p) q ps\""], ["proof (state)\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "have \"set ps \\<union> { q } = set ?ps'\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set ps \\<union> {q} = set (insort_key (\\<lambda>q. dist q p) q ps)", "by (simp add: set_insort_key)"], ["proof (state)\nthis:\n  set ps \\<union> {q} = set (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "moreover"], ["proof (state)\nthis:\n  set ps \\<union> {q} = set (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "have \"set ?ps' = set (take n ?ps') \\<union> set (drop n ?ps')\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set (insort_key (\\<lambda>q. dist q p) q ps) =\n    set (take n (insort_key (\\<lambda>q. dist q p) q ps)) \\<union>\n    set (drop n (insort_key (\\<lambda>q. dist q p) q ps))", "using append_take_drop_id set_append"], ["proof (prove)\nusing this:\n  take ?n ?xs @ drop ?n ?xs = ?xs\n  set (?xs @ ?ys) = set ?xs \\<union> set ?ys\n\ngoal (1 subgoal):\n 1. set (insort_key (\\<lambda>q. dist q p) q ps) =\n    set (take n (insort_key (\\<lambda>q. dist q p) q ps)) \\<union>\n    set (drop n (insort_key (\\<lambda>q. dist q p) q ps))", "by metis"], ["proof (state)\nthis:\n  set (insort_key (\\<lambda>q. dist q p) q ps) =\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps)) \\<union>\n  set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "ultimately"], ["proof (chain)\npicking this:\n  set ps \\<union> {q} = set (insort_key (\\<lambda>q. dist q p) q ps)\n  set (insort_key (\\<lambda>q. dist q p) q ps) =\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps)) \\<union>\n  set (drop n (insort_key (\\<lambda>q. dist q p) q ps))", "have \"set ps \\<union> { q } - set (take n ?ps') \\<subseteq> set (drop n ?ps')\""], ["proof (prove)\nusing this:\n  set ps \\<union> {q} = set (insort_key (\\<lambda>q. dist q p) q ps)\n  set (insort_key (\\<lambda>q. dist q p) q ps) =\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps)) \\<union>\n  set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n\ngoal (1 subgoal):\n 1. set ps \\<union> {q} -\n    set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n    \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))", "by blast"], ["proof (state)\nthis:\n  set ps \\<union> {q} -\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n  \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "moreover"], ["proof (state)\nthis:\n  set ps \\<union> {q} -\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n  \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "have \"sorted_wrt_dist p ?ps'\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)", "using assms sorted_wrt_dist_insort_key"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p ps\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (insort_key (\\<lambda>q. dist q ?p) ?q ?ps)\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)", "by blast"], ["proof (state)\nthis:\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "ultimately"], ["proof (chain)\npicking this:\n  set ps \\<union> {q} -\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n  \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)", "show ?thesis"], ["proof (prove)\nusing this:\n  set ps \\<union> {q} -\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n  \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n       \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p", "unfolding upd_nbors_def"], ["proof (prove)\nusing this:\n  set ps \\<union> {q} -\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n  \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} -\n                   set (take n (insort_key (\\<lambda>q. dist q p) q ps)).\n       \\<forall>s\\<in>set (take n (insort_key (\\<lambda>q. dist q p) q ps)).\n          dist s p \\<le> dist r p", "using sorted_wrt_dist_take_drop"], ["proof (prove)\nusing this:\n  set ps \\<union> {q} -\n  set (take n (insort_key (\\<lambda>q. dist q p) q ps))\n  \\<subseteq> set (drop n (insort_key (\\<lambda>q. dist q p) q ps))\n  sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps)\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  \\<forall>p\\<^sub>0\\<in>set (take ?n ?ps).\n     \\<forall>p\\<^sub>1\\<in>set (drop ?n ?ps).\n        dist p\\<^sub>0 ?p \\<le> dist p\\<^sub>1 ?p\n\ngoal (1 subgoal):\n 1. \\<forall>r\\<in>set ps \\<union> {q} -\n                   set (take n (insort_key (\\<lambda>q. dist q p) q ps)).\n       \\<forall>s\\<in>set (take n (insort_key (\\<lambda>q. dist q p) q ps)).\n          dist s p \\<le> dist r p", "by blast"], ["proof (state)\nthis:\n  \\<forall>r\\<in>set ps \\<union> {q} - set (upd_nbors n p q ps).\n     \\<forall>s\\<in>set (upd_nbors n p q ps). dist s p \\<le> dist r p\n\ngoal:\nNo subgoals!", "qed"], ["", "lemma sorted_wrt_dist_last_upd_nbors_mono:\n  assumes \"sorted_wrt_dist p ps\" \"n \\<le> length ps\" \"0 < n\"\n  shows \"dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "proof (cases \"insort_key (\\<lambda>q. dist q p) q ps = ps @ [q]\")"], ["proof (state)\ngoal (2 subgoals):\n 1. insort_key (\\<lambda>q. dist q p) q ps = ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p\n 2. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "case True"], ["proof (state)\nthis:\n  insort_key (\\<lambda>q. dist q p) q ps = ps @ [q]\n\ngoal (2 subgoals):\n 1. insort_key (\\<lambda>q. dist q p) q ps = ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p\n 2. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "thus ?thesis"], ["proof (prove)\nusing this:\n  insort_key (\\<lambda>q. dist q p) q ps = ps @ [q]\n\ngoal (1 subgoal):\n 1. dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "unfolding upd_nbors_def"], ["proof (prove)\nusing this:\n  insort_key (\\<lambda>q. dist q p) q ps = ps @ [q]\n\ngoal (1 subgoal):\n 1. dist (last (take n (insort_key (\\<lambda>q. dist q p) q ps))) p\n    \\<le> dist (last ps) p", "using assms sorted_wrt_dist_last_take_mono"], ["proof (prove)\nusing this:\n  insort_key (\\<lambda>q. dist q p) q ps = ps @ [q]\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n  \\<lbrakk>sorted_wrt_dist ?p ?ps; ?n \\<le> length ?ps; 0 < ?n\\<rbrakk>\n  \\<Longrightarrow> dist (last (take ?n ?ps)) ?p \\<le> dist (last ?ps) ?p\n\ngoal (1 subgoal):\n 1. dist (last (take n (insort_key (\\<lambda>q. dist q p) q ps))) p\n    \\<le> dist (last ps) p", "by auto"], ["proof (state)\nthis:\n  dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p\n\ngoal (1 subgoal):\n 1. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "next"], ["proof (state)\ngoal (1 subgoal):\n 1. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "case False"], ["proof (state)\nthis:\n  insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\n\ngoal (1 subgoal):\n 1. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "hence \"last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\""], ["proof (prove)\nusing this:\n  insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\n\ngoal (1 subgoal):\n 1. last (insort_key (\\<lambda>q. dist q p) q ps) = last ps", "using sorted_wrt_dist_last_insort_key_eq assms"], ["proof (prove)\nusing this:\n  insort_key (\\<lambda>q. dist q p) q ps \\<noteq> ps @ [q]\n  \\<lbrakk>sorted_wrt_dist ?p ?ps;\n   insort_key (\\<lambda>q. dist q ?p) ?q ?ps \\<noteq> ?ps @ [?q]\\<rbrakk>\n  \\<Longrightarrow> last (insort_key (\\<lambda>q. dist q ?p) ?q ?ps) =\n                    last ?ps\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n\ngoal (1 subgoal):\n 1. last (insort_key (\\<lambda>q. dist q p) q ps) = last ps", "by blast"], ["proof (state)\nthis:\n  last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\n\ngoal (1 subgoal):\n 1. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "moreover"], ["proof (state)\nthis:\n  last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\n\ngoal (1 subgoal):\n 1. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "have \"dist (last (upd_nbors  n p q ps)) p \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (upd_nbors n p q ps)) p\n    \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p", "unfolding upd_nbors_def"], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (take n (insort_key (\\<lambda>q. dist q p) q ps))) p\n    \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p", "using assms sorted_wrt_dist_last_take_mono[of p \"insort_key (\\<lambda>q. dist q p) q ps\"]"], ["proof (prove)\nusing this:\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n  \\<lbrakk>sorted_wrt_dist p (insort_key (\\<lambda>q. dist q p) q ps);\n   ?n \\<le> length (insort_key (\\<lambda>q. dist q p) q ps); 0 < ?n\\<rbrakk>\n  \\<Longrightarrow> dist\n                     (last\n                       (take ?n (insort_key (\\<lambda>q. dist q p) q ps)))\n                     p\n                    \\<le> dist\n                           (last (insort_key (\\<lambda>q. dist q p) q ps)) p\n\ngoal (1 subgoal):\n 1. dist (last (take n (insort_key (\\<lambda>q. dist q p) q ps))) p\n    \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p", "by (simp add: sorted_wrt_dist_insort_key)"], ["proof (state)\nthis:\n  dist (last (upd_nbors n p q ps)) p\n  \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p\n\ngoal (1 subgoal):\n 1. insort_key (\\<lambda>q. dist q p) q ps \\<noteq>\n    ps @ [q] \\<Longrightarrow>\n    dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "ultimately"], ["proof (chain)\npicking this:\n  last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\n  dist (last (upd_nbors n p q ps)) p\n  \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p", "show ?thesis"], ["proof (prove)\nusing this:\n  last (insort_key (\\<lambda>q. dist q p) q ps) = last ps\n  dist (last (upd_nbors n p q ps)) p\n  \\<le> dist (last (insort_key (\\<lambda>q. dist q p) q ps)) p\n\ngoal (1 subgoal):\n 1. dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p", "by simp"], ["proof (state)\nthis:\n  dist (last (upd_nbors n p q ps)) p \\<le> dist (last ps) p\n\ngoal:\nNo subgoals!", "qed"], ["", "subsection \\<open>The Recursive Nearest Neighbor Algorithm\\<close>"], ["", "fun nearest_nbors :: \"nat \\<Rightarrow> ('k::finite) point list \\<Rightarrow> 'k point \\<Rightarrow> 'k kdt \\<Rightarrow> 'k point list\" where\n  \"nearest_nbors n ps p (Leaf q) = upd_nbors n p q ps\"\n| \"nearest_nbors n ps p (Node k v l r) = (\n    if p$k \\<le> v then\n      let candidates = nearest_nbors n ps p l in\n      if length candidates = n \\<and> dist p (last candidates) \\<le> dist v (p$k) then\n        candidates\n      else\n        nearest_nbors n candidates p r\n    else\n      let candidates = nearest_nbors n ps p r in\n      if length candidates = n \\<and> dist p (last candidates) \\<le> dist v (p$k) then\n        candidates\n      else\n        nearest_nbors n candidates p l\n  )\""], ["", "subsection \\<open>Auxiliary Lemmas\\<close>"], ["", "lemma cutoff_r:\n  assumes \"invar (Node k v l r)\"\n  assumes \"p$k \\<le> v\" \"dist p c \\<le> dist (p$k) v\"\n  shows \"\\<forall>q \\<in> set_kdt r. dist p c \\<le> dist p q\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r. dist p c \\<le> dist p q", "proof standard"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "fix q"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "assume *: \"q \\<in> set_kdt r\""], ["proof (state)\nthis:\n  q \\<in> set_kdt r\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "have \"dist p c \\<le> dist (p$k) v\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist p c \\<le> dist (p $ k) v", "using assms(3)"], ["proof (prove)\nusing this:\n  dist p c \\<le> dist (p $ k) v\n\ngoal (1 subgoal):\n 1. dist p c \\<le> dist (p $ k) v", "by blast"], ["proof (state)\nthis:\n  dist p c \\<le> dist (p $ k) v\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "also"], ["proof (state)\nthis:\n  dist p c \\<le> dist (p $ k) v\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "have \"... \\<le> dist (p$k) v + dist v (q$k)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (p $ k) v \\<le> dist (p $ k) v + dist v (q $ k)", "by simp"], ["proof (state)\nthis:\n  dist (p $ k) v \\<le> dist (p $ k) v + dist v (q $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "also"], ["proof (state)\nthis:\n  dist (p $ k) v \\<le> dist (p $ k) v + dist v (q $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "have \"... = dist (p$k) (q$k)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (p $ k) v + dist v (q $ k) = dist (p $ k) (q $ k)", "using * assms(1,2) dist_real_def"], ["proof (prove)\nusing this:\n  q \\<in> set_kdt r\n  invar (Node k v l r)\n  p $ k \\<le> v\n  dist ?x ?y = \\<bar>?x - ?y\\<bar>\n\ngoal (1 subgoal):\n 1. dist (p $ k) v + dist v (q $ k) = dist (p $ k) (q $ k)", "by auto"], ["proof (state)\nthis:\n  dist (p $ k) v + dist v (q $ k) = dist (p $ k) (q $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "also"], ["proof (state)\nthis:\n  dist (p $ k) v + dist v (q $ k) = dist (p $ k) (q $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "have \"... \\<le> dist p q\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (p $ k) (q $ k) \\<le> dist p q", "using dist_vec_nth_le"], ["proof (prove)\nusing this:\n  dist (?x $ ?i) (?y $ ?i) \\<le> dist ?x ?y\n\ngoal (1 subgoal):\n 1. dist (p $ k) (q $ k) \\<le> dist p q", "by blast"], ["proof (state)\nthis:\n  dist (p $ k) (q $ k) \\<le> dist p q\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt r \\<Longrightarrow> dist p c \\<le> dist p q", "finally"], ["proof (chain)\npicking this:\n  dist p c \\<le> dist p q", "show \"dist p c \\<le> dist p q\""], ["proof (prove)\nusing this:\n  dist p c \\<le> dist p q\n\ngoal (1 subgoal):\n 1. dist p c \\<le> dist p q", "."], ["proof (state)\nthis:\n  dist p c \\<le> dist p q\n\ngoal:\nNo subgoals!", "qed"], ["", "lemma cutoff_l:\n  assumes \"invar (Node k v l r)\"\n  assumes \"v \\<le> p$k\" \"dist p c \\<le> dist v (p$k)\"\n  shows \"\\<forall>q \\<in> set_kdt l. dist p c \\<le> dist p q\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l. dist p c \\<le> dist p q", "proof standard"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "fix q"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "assume *: \"q \\<in> set_kdt l\""], ["proof (state)\nthis:\n  q \\<in> set_kdt l\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "have \"dist p c \\<le> dist v (p$k)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist p c \\<le> dist v (p $ k)", "using assms(3)"], ["proof (prove)\nusing this:\n  dist p c \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. dist p c \\<le> dist v (p $ k)", "by blast"], ["proof (state)\nthis:\n  dist p c \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "also"], ["proof (state)\nthis:\n  dist p c \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "have \"... \\<le> dist v (p$k) + dist (q$k) v\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist v (p $ k) \\<le> dist v (p $ k) + dist (q $ k) v", "by simp"], ["proof (state)\nthis:\n  dist v (p $ k) \\<le> dist v (p $ k) + dist (q $ k) v\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "also"], ["proof (state)\nthis:\n  dist v (p $ k) \\<le> dist v (p $ k) + dist (q $ k) v\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "have \"... = dist (p$k) (q$k)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist v (p $ k) + dist (q $ k) v = dist (p $ k) (q $ k)", "using * assms(1,2) dist_real_def"], ["proof (prove)\nusing this:\n  q \\<in> set_kdt l\n  invar (Node k v l r)\n  v \\<le> p $ k\n  dist ?x ?y = \\<bar>?x - ?y\\<bar>\n\ngoal (1 subgoal):\n 1. dist v (p $ k) + dist (q $ k) v = dist (p $ k) (q $ k)", "by auto"], ["proof (state)\nthis:\n  dist v (p $ k) + dist (q $ k) v = dist (p $ k) (q $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "also"], ["proof (state)\nthis:\n  dist v (p $ k) + dist (q $ k) v = dist (p $ k) (q $ k)\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "have \"... \\<le> dist p q\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (p $ k) (q $ k) \\<le> dist p q", "using dist_vec_nth_le"], ["proof (prove)\nusing this:\n  dist (?x $ ?i) (?y $ ?i) \\<le> dist ?x ?y\n\ngoal (1 subgoal):\n 1. dist (p $ k) (q $ k) \\<le> dist p q", "by blast"], ["proof (state)\nthis:\n  dist (p $ k) (q $ k) \\<le> dist p q\n\ngoal (1 subgoal):\n 1. \\<And>q. q \\<in> set_kdt l \\<Longrightarrow> dist p c \\<le> dist p q", "finally"], ["proof (chain)\npicking this:\n  dist p c \\<le> dist p q", "show \"dist p c \\<le> dist p q\""], ["proof (prove)\nusing this:\n  dist p c \\<le> dist p q\n\ngoal (1 subgoal):\n 1. dist p c \\<le> dist p q", "."], ["proof (state)\nthis:\n  dist p c \\<le> dist p q\n\ngoal:\nNo subgoals!", "qed"], ["", "subsection \\<open>The Main Theorems\\<close>"], ["", "lemma set_nns:\n  \"set (nearest_nbors n ps p kdt) \\<subseteq> set_kdt kdt \\<union> set ps\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p kdt) \\<subseteq> set_kdt kdt \\<union> set ps", "apply (induction kdt arbitrary: ps)"], ["proof (prove)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       set (nearest_nbors n ps p (Leaf x))\n       \\<subseteq> set_kdt (Leaf x) \\<union> set ps\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   set (nearest_nbors n ps p kdt1)\n                   \\<subseteq> set_kdt kdt1 \\<union> set ps;\n        \\<And>ps.\n           set (nearest_nbors n ps p kdt2)\n           \\<subseteq> set_kdt kdt2 \\<union> set ps\\<rbrakk>\n       \\<Longrightarrow> set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))\n                         \\<subseteq> set_kdt\n(Node x1a x2 kdt1 kdt2) \\<union>\n                                     set ps", "apply (auto simp: Let_def upd_nbors_def set_insort_key)"], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<And>x ps xa.\n       \\<lbrakk>xa \\<in> set (take n\n                               (insort_key (\\<lambda>q. dist q p) x ps));\n        xa \\<notin> set ps\\<rbrakk>\n       \\<Longrightarrow> xa = x", "using in_set_takeD set_insort_key"], ["proof (prove)\nusing this:\n  ?x \\<in> set (take ?n ?xs) \\<Longrightarrow> ?x \\<in> set ?xs\n  set (insort_key ?f ?x ?xs) = insert ?x (set ?xs)\n\ngoal (1 subgoal):\n 1. \\<And>x ps xa.\n       \\<lbrakk>xa \\<in> set (take n\n                               (insort_key (\\<lambda>q. dist q p) x ps));\n        xa \\<notin> set ps\\<rbrakk>\n       \\<Longrightarrow> xa = x", "by fastforce"], ["", "lemma length_nns:\n  \"length (nearest_nbors n ps p kdt) = min n (size_kdt kdt + length ps)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p kdt) =\n    min n (KD_Tree.size_kdt kdt + length ps)", "by (induction kdt arbitrary: ps) (auto simp: Let_def upd_nbors_def)"], ["", "lemma length_nns_gt_0:\n  \"0 < n \\<Longrightarrow> 0 < length (nearest_nbors n ps p kdt)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. 0 < n \\<Longrightarrow> 0 < length (nearest_nbors n ps p kdt)", "by (induction kdt arbitrary: ps) (auto simp: Let_def upd_nbors_def)"], ["", "lemma length_nns_n:\n  assumes \"(set_kdt kdt \\<union> set ps) - set (nearest_nbors n ps p kdt) \\<noteq> {}\"\n  shows \"length (nearest_nbors n ps p kdt) = n\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p kdt) = n", "using assms"], ["proof (prove)\nusing this:\n  set_kdt kdt \\<union> set ps - set (nearest_nbors n ps p kdt) \\<noteq> {}\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p kdt) = n", "proof (induction kdt arbitrary: ps)"], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       set_kdt (Leaf x) \\<union> set ps -\n       set (nearest_nbors n ps p (Leaf x)) \\<noteq>\n       {} \\<Longrightarrow>\n       length (nearest_nbors n ps p (Leaf x)) = n\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   set_kdt kdt1 \\<union> set ps -\n                   set (nearest_nbors n ps p kdt1) \\<noteq>\n                   {} \\<Longrightarrow>\n                   length (nearest_nbors n ps p kdt1) = n;\n        \\<And>ps.\n           set_kdt kdt2 \\<union> set ps -\n           set (nearest_nbors n ps p kdt2) \\<noteq>\n           {} \\<Longrightarrow>\n           length (nearest_nbors n ps p kdt2) = n;\n        set_kdt (Node x1a x2 kdt1 kdt2) \\<union> set ps -\n        set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) \\<noteq>\n        {}\\<rbrakk>\n       \\<Longrightarrow> length\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) =\n                         n", "case (Node k v l r)"], ["proof (state)\nthis:\n  set_kdt l \\<union> set ?ps - set (nearest_nbors n ?ps p l) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors n ?ps p l) = n\n  set_kdt r \\<union> set ?ps - set (nearest_nbors n ?ps p r) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors n ?ps p r) = n\n  set_kdt (Node k v l r) \\<union> set ps -\n  set (nearest_nbors n ps p (Node k v l r)) \\<noteq>\n  {}\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       set_kdt (Leaf x) \\<union> set ps -\n       set (nearest_nbors n ps p (Leaf x)) \\<noteq>\n       {} \\<Longrightarrow>\n       length (nearest_nbors n ps p (Leaf x)) = n\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   set_kdt kdt1 \\<union> set ps -\n                   set (nearest_nbors n ps p kdt1) \\<noteq>\n                   {} \\<Longrightarrow>\n                   length (nearest_nbors n ps p kdt1) = n;\n        \\<And>ps.\n           set_kdt kdt2 \\<union> set ps -\n           set (nearest_nbors n ps p kdt2) \\<noteq>\n           {} \\<Longrightarrow>\n           length (nearest_nbors n ps p kdt2) = n;\n        set_kdt (Node x1a x2 kdt1 kdt2) \\<union> set ps -\n        set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) \\<noteq>\n        {}\\<rbrakk>\n       \\<Longrightarrow> length\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) =\n                         n", "let ?nnsl = \"nearest_nbors n ps p l\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       set_kdt (Leaf x) \\<union> set ps -\n       set (nearest_nbors n ps p (Leaf x)) \\<noteq>\n       {} \\<Longrightarrow>\n       length (nearest_nbors n ps p (Leaf x)) = n\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   set_kdt kdt1 \\<union> set ps -\n                   set (nearest_nbors n ps p kdt1) \\<noteq>\n                   {} \\<Longrightarrow>\n                   length (nearest_nbors n ps p kdt1) = n;\n        \\<And>ps.\n           set_kdt kdt2 \\<union> set ps -\n           set (nearest_nbors n ps p kdt2) \\<noteq>\n           {} \\<Longrightarrow>\n           length (nearest_nbors n ps p kdt2) = n;\n        set_kdt (Node x1a x2 kdt1 kdt2) \\<union> set ps -\n        set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) \\<noteq>\n        {}\\<rbrakk>\n       \\<Longrightarrow> length\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) =\n                         n", "let ?nnsr = \"nearest_nbors n ps p r\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       set_kdt (Leaf x) \\<union> set ps -\n       set (nearest_nbors n ps p (Leaf x)) \\<noteq>\n       {} \\<Longrightarrow>\n       length (nearest_nbors n ps p (Leaf x)) = n\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   set_kdt kdt1 \\<union> set ps -\n                   set (nearest_nbors n ps p kdt1) \\<noteq>\n                   {} \\<Longrightarrow>\n                   length (nearest_nbors n ps p kdt1) = n;\n        \\<And>ps.\n           set_kdt kdt2 \\<union> set ps -\n           set (nearest_nbors n ps p kdt2) \\<noteq>\n           {} \\<Longrightarrow>\n           length (nearest_nbors n ps p kdt2) = n;\n        set_kdt (Node x1a x2 kdt1 kdt2) \\<union> set ps -\n        set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) \\<noteq>\n        {}\\<rbrakk>\n       \\<Longrightarrow> length\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) =\n                         n", "consider (A) \"p$k \\<le> v \\<and> length ?nnsl = n \\<and> dist p (last ?nnsl) \\<le> dist v (p$k)\"\n         | (B) \"p$k \\<le> v \\<and> \\<not>(length ?nnsl = n \\<and> dist p (last ?nnsl) \\<le> dist v (p$k))\"\n         | (C) \"v < p$k \\<and> length ?nnsr = n \\<and> dist p (last ?nnsr) \\<le> dist v (p$k)\"\n         | (D) \"v < p$k \\<and> \\<not>(length ?nnsr = n \\<and> dist p (last ?nnsr) \\<le> dist v (p$k))\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<lbrakk>p $ k \\<le> v \\<and>\n             length (nearest_nbors n ps p l) = n \\<and>\n             dist p (last (nearest_nbors n ps p l))\n             \\<le> dist v (p $ k) \\<Longrightarrow>\n             thesis;\n     p $ k \\<le> v \\<and>\n     \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n             dist p (last (nearest_nbors n ps p l))\n             \\<le> dist v (p $ k)) \\<Longrightarrow>\n     thesis;\n     v < p $ k \\<and>\n     length (nearest_nbors n ps p r) = n \\<and>\n     dist p (last (nearest_nbors n ps p r))\n     \\<le> dist v (p $ k) \\<Longrightarrow>\n     thesis;\n     v < p $ k \\<and>\n     \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n             dist p (last (nearest_nbors n ps p r))\n             \\<le> dist v (p $ k)) \\<Longrightarrow>\n     thesis\\<rbrakk>\n    \\<Longrightarrow> thesis", "by argo"], ["proof (state)\nthis:\n  \\<lbrakk>p $ k \\<le> v \\<and>\n           length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k) \\<Longrightarrow>\n           ?thesis;\n   p $ k \\<le> v \\<and>\n   \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   length (nearest_nbors n ps p r) = n \\<and>\n   dist p (last (nearest_nbors n ps p r))\n   \\<le> dist v (p $ k) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n           dist p (last (nearest_nbors n ps p r))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis\\<rbrakk>\n  \\<Longrightarrow> ?thesis\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       set_kdt (Leaf x) \\<union> set ps -\n       set (nearest_nbors n ps p (Leaf x)) \\<noteq>\n       {} \\<Longrightarrow>\n       length (nearest_nbors n ps p (Leaf x)) = n\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   set_kdt kdt1 \\<union> set ps -\n                   set (nearest_nbors n ps p kdt1) \\<noteq>\n                   {} \\<Longrightarrow>\n                   length (nearest_nbors n ps p kdt1) = n;\n        \\<And>ps.\n           set_kdt kdt2 \\<union> set ps -\n           set (nearest_nbors n ps p kdt2) \\<noteq>\n           {} \\<Longrightarrow>\n           length (nearest_nbors n ps p kdt2) = n;\n        set_kdt (Node x1a x2 kdt1 kdt2) \\<union> set ps -\n        set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) \\<noteq>\n        {}\\<rbrakk>\n       \\<Longrightarrow> length\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)) =\n                         n", "thus ?case"], ["proof (prove)\nusing this:\n  \\<lbrakk>p $ k \\<le> v \\<and>\n           length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k) \\<Longrightarrow>\n           ?thesis;\n   p $ k \\<le> v \\<and>\n   \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   length (nearest_nbors n ps p r) = n \\<and>\n   dist p (last (nearest_nbors n ps p r))\n   \\<le> dist v (p $ k) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n           dist p (last (nearest_nbors n ps p r))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis\\<rbrakk>\n  \\<Longrightarrow> ?thesis\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p (Node k v l r)) = n", "proof cases"], ["proof (state)\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "case B"], ["proof (state)\nthis:\n  p $ k \\<le> v \\<and>\n  \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n          dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k))\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "let ?nns = \"nearest_nbors n ?nnsl p r\""], ["proof (state)\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "have \"length ?nnsl \\<noteq> n \\<longrightarrow> (set_kdt l \\<union> set ps - set (nearest_nbors n ps p l) = {})\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n    set_kdt l \\<union> set ps - set (nearest_nbors n ps p l) = {}", "using Node.IH(1)"], ["proof (prove)\nusing this:\n  set_kdt l \\<union> set ?ps - set (nearest_nbors n ?ps p l) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors n ?ps p l) = n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n    set_kdt l \\<union> set ps - set (nearest_nbors n ps p l) = {}", "by blast"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set ps - set (nearest_nbors n ps p l) = {}\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "hence \"length ?nnsl \\<noteq> n \\<longrightarrow> (set_kdt r \\<union> set ?nnsl - set ?nns \\<noteq> {})\""], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set ps - set (nearest_nbors n ps p l) = {}\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n    set_kdt r \\<union> set (nearest_nbors n ps p l) -\n    set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n    {}", "using B Node.prems"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set ps - set (nearest_nbors n ps p l) = {}\n  p $ k \\<le> v \\<and>\n  \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n          dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k))\n  set_kdt (Node k v l r) \\<union> set ps -\n  set (nearest_nbors n ps p (Node k v l r)) \\<noteq>\n  {}\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n    set_kdt r \\<union> set (nearest_nbors n ps p l) -\n    set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n    {}", "by auto"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set (nearest_nbors n ps p l) -\n  set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n  {}\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "moreover"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set (nearest_nbors n ps p l) -\n  set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n  {}\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "have \"length ?nnsl = n \\<longrightarrow> ?thesis\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) = n \\<longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "using B"], ["proof (prove)\nusing this:\n  p $ k \\<le> v \\<and>\n  \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n          dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k))\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) = n \\<longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "by (auto simp: length_nns)"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p l) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "ultimately"], ["proof (chain)\npicking this:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set (nearest_nbors n ps p l) -\n  set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n  {}\n  length (nearest_nbors n ps p l) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n", "show ?thesis"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set (nearest_nbors n ps p l) -\n  set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n  {}\n  length (nearest_nbors n ps p l) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p (Node k v l r)) = n", "using B Node.IH(2)"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set (nearest_nbors n ps p l) -\n  set (nearest_nbors n (nearest_nbors n ps p l) p r) \\<noteq>\n  {}\n  length (nearest_nbors n ps p l) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n\n  p $ k \\<le> v \\<and>\n  \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n          dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k))\n  set_kdt r \\<union> set ?ps - set (nearest_nbors n ?ps p r) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors n ?ps p r) = n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p (Node k v l r)) = n", "by force"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "next"], ["proof (state)\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "case D"], ["proof (state)\nthis:\n  v < p $ k \\<and>\n  \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n          dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k))\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "let ?nns = \"nearest_nbors n ?nnsr p l\""], ["proof (state)\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "have \"length ?nnsr \\<noteq> n \\<longrightarrow> (set_kdt r \\<union> set ps - set (nearest_nbors n ps p r) = {})\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n    set_kdt r \\<union> set ps - set (nearest_nbors n ps p r) = {}", "using Node.IH(2)"], ["proof (prove)\nusing this:\n  set_kdt r \\<union> set ?ps - set (nearest_nbors n ?ps p r) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors n ?ps p r) = n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n    set_kdt r \\<union> set ps - set (nearest_nbors n ps p r) = {}", "by blast"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set ps - set (nearest_nbors n ps p r) = {}\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "hence \"length ?nnsr \\<noteq> n \\<longrightarrow> (set_kdt l \\<union> set ?nnsr - set ?nns \\<noteq> {})\""], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set ps - set (nearest_nbors n ps p r) = {}\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n    set_kdt l \\<union> set (nearest_nbors n ps p r) -\n    set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n    {}", "using D Node.prems"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt r \\<union> set ps - set (nearest_nbors n ps p r) = {}\n  v < p $ k \\<and>\n  \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n          dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k))\n  set_kdt (Node k v l r) \\<union> set ps -\n  set (nearest_nbors n ps p (Node k v l r)) \\<noteq>\n  {}\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n    set_kdt l \\<union> set (nearest_nbors n ps p r) -\n    set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n    {}", "by auto"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set (nearest_nbors n ps p r) -\n  set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n  {}\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "moreover"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set (nearest_nbors n ps p r) -\n  set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n  {}\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "have \"length ?nnsr = n \\<longrightarrow> ?thesis\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) = n \\<longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "using D"], ["proof (prove)\nusing this:\n  v < p $ k \\<and>\n  \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n          dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k))\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) = n \\<longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "by (auto simp: length_nns)"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p r) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "ultimately"], ["proof (chain)\npicking this:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set (nearest_nbors n ps p r) -\n  set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n  {}\n  length (nearest_nbors n ps p r) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n", "show ?thesis"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set (nearest_nbors n ps p r) -\n  set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n  {}\n  length (nearest_nbors n ps p r) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p (Node k v l r)) = n", "using D Node.IH(1)"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) \\<noteq> n \\<longrightarrow>\n  set_kdt l \\<union> set (nearest_nbors n ps p r) -\n  set (nearest_nbors n (nearest_nbors n ps p r) p l) \\<noteq>\n  {}\n  length (nearest_nbors n ps p r) = n \\<longrightarrow>\n  length (nearest_nbors n ps p (Node k v l r)) = n\n  v < p $ k \\<and>\n  \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n          dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k))\n  set_kdt l \\<union> set ?ps - set (nearest_nbors n ?ps p l) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors n ?ps p l) = n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p (Node k v l r)) = n", "by force"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (2 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    length (nearest_nbors n ps p (Node k v l r)) = n", "qed auto"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p (Node k v l r)) = n\n\ngoal (1 subgoal):\n 1. \\<And>x ps.\n       set_kdt (Leaf x) \\<union> set ps -\n       set (nearest_nbors n ps p (Leaf x)) \\<noteq>\n       {} \\<Longrightarrow>\n       length (nearest_nbors n ps p (Leaf x)) = n", "qed (auto simp: upd_nbors_def min_def set_insort_key)"], ["", "lemma sorted_nns:\n  \"sorted_wrt_dist p ps \\<Longrightarrow> sorted_wrt_dist p (nearest_nbors n ps p kdt)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p ps \\<Longrightarrow>\n    sorted_wrt_dist p (nearest_nbors n ps p kdt)", "using sorted_wrt_dist_nbors"], ["proof (prove)\nusing this:\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (upd_nbors ?n ?p ?q ?ps)\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p ps \\<Longrightarrow>\n    sorted_wrt_dist p (nearest_nbors n ps p kdt)", "by (induction kdt arbitrary: ps) (auto simp: Let_def)"], ["", "lemma distinct_nns:\n  assumes \"invar kdt\" \"distinct ps\" \"set ps \\<inter> set_kdt kdt = {}\"\n  shows \"distinct (nearest_nbors n ps p kdt)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p kdt)", "using assms"], ["proof (prove)\nusing this:\n  invar kdt\n  distinct ps\n  set ps \\<inter> set_kdt kdt = {}\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p kdt)", "proof (induction kdt arbitrary: ps)"], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "case (Node k v l r)"], ["proof (state)\nthis:\n  \\<lbrakk>invar l; distinct ?ps; set ?ps \\<inter> set_kdt l = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors n ?ps p l)\n  \\<lbrakk>invar r; distinct ?ps; set ?ps \\<inter> set_kdt r = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors n ?ps p r)\n  invar (Node k v l r)\n  distinct ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "let ?nnsl = \"nearest_nbors n ps p l\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "let ?nnsr = \"nearest_nbors n ps p r\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "have \"set ps \\<inter> set_kdt l = {}\" \"set ps \\<inter> set_kdt r = {}\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set ps \\<inter> set_kdt l = {} &&& set ps \\<inter> set_kdt r = {}", "using Node.prems(3)"], ["proof (prove)\nusing this:\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n\ngoal (1 subgoal):\n 1. set ps \\<inter> set_kdt l = {} &&& set ps \\<inter> set_kdt r = {}", "by auto"], ["proof (state)\nthis:\n  set ps \\<inter> set_kdt l = {}\n  set ps \\<inter> set_kdt r = {}\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "hence DCLR: \"distinct ?nnsl\" \"distinct ?nnsr\""], ["proof (prove)\nusing this:\n  set ps \\<inter> set_kdt l = {}\n  set ps \\<inter> set_kdt r = {}\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p l) &&& distinct (nearest_nbors n ps p r)", "using Node invar_l invar_r"], ["proof (prove)\nusing this:\n  set ps \\<inter> set_kdt l = {}\n  set ps \\<inter> set_kdt r = {}\n  \\<lbrakk>invar l; distinct ?ps; set ?ps \\<inter> set_kdt l = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors n ?ps p l)\n  \\<lbrakk>invar r; distinct ?ps; set ?ps \\<inter> set_kdt r = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors n ?ps p r)\n  invar (Node k v l r)\n  distinct ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p l) &&& distinct (nearest_nbors n ps p r)", "by blast+"], ["proof (state)\nthis:\n  distinct (nearest_nbors n ps p l)\n  distinct (nearest_nbors n ps p r)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "have \"set ?nnsl \\<inter> set_kdt r = {}\" \"set ?nnsr \\<inter> set_kdt l = {}\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p l) \\<inter> set_kdt r = {} &&&\n    set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}", "using Node.prems(1,3) set_nns"], ["proof (prove)\nusing this:\n  invar (Node k v l r)\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  set (nearest_nbors ?n ?ps ?p ?kdt)\n  \\<subseteq> set_kdt ?kdt \\<union> set ?ps\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p l) \\<inter> set_kdt r = {} &&&\n    set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}", "by fastforce+"], ["proof (state)\nthis:\n  set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\n  set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "hence \"distinct (nearest_nbors n ?nnsl p r)\" \"distinct (nearest_nbors n ?nnsr p l)\""], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\n  set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n (nearest_nbors n ps p l) p r) &&&\n    distinct (nearest_nbors n (nearest_nbors n ps p r) p l)", "using Node.IH(1,2) Node.prems(1,2) DCLR invar_l invar_r"], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\n  set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\n  \\<lbrakk>invar l; distinct ?ps; set ?ps \\<inter> set_kdt l = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors n ?ps p l)\n  \\<lbrakk>invar r; distinct ?ps; set ?ps \\<inter> set_kdt r = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors n ?ps p r)\n  invar (Node k v l r)\n  distinct ps\n  distinct (nearest_nbors n ps p l)\n  distinct (nearest_nbors n ps p r)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n (nearest_nbors n ps p l) p r) &&&\n    distinct (nearest_nbors n (nearest_nbors n ps p r) p l)", "by blast+"], ["proof (state)\nthis:\n  distinct (nearest_nbors n (nearest_nbors n ps p l) p r)\n  distinct (nearest_nbors n (nearest_nbors n ps p r) p l)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; distinct ps;\n                    set ps \\<inter> set_kdt kdt1 = {}\\<rbrakk>\n                   \\<Longrightarrow> distinct (nearest_nbors n ps p kdt1);\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; distinct ps;\n            set ps \\<inter> set_kdt kdt2 = {}\\<rbrakk>\n           \\<Longrightarrow> distinct (nearest_nbors n ps p kdt2);\n        invar (Node x1a x2 kdt1 kdt2); distinct ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct\n                          (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2))", "thus ?case"], ["proof (prove)\nusing this:\n  distinct (nearest_nbors n (nearest_nbors n ps p l) p r)\n  distinct (nearest_nbors n (nearest_nbors n ps p r) p l)\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p (Node k v l r))", "using DCLR"], ["proof (prove)\nusing this:\n  distinct (nearest_nbors n (nearest_nbors n ps p l) p r)\n  distinct (nearest_nbors n (nearest_nbors n ps p r) p l)\n  distinct (nearest_nbors n ps p l)\n  distinct (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p (Node k v l r))", "by (auto simp add: Let_def)"], ["proof (state)\nthis:\n  distinct (nearest_nbors n ps p (Node k v l r))\n\ngoal (1 subgoal):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); distinct ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}\\<rbrakk>\n       \\<Longrightarrow> distinct (nearest_nbors n ps p (Leaf x))", "qed (auto simp: upd_nbors_def distinct_insort)"], ["", "lemma last_nns_mono:\n  assumes \"invar kdt\" \"sorted_wrt_dist p ps\" \"n \\<le> length ps\" \"0 < n\"\n  shows \"dist (last (nearest_nbors n ps p kdt)) p \\<le> dist (last ps) p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p kdt)) p \\<le> dist (last ps) p", "using assms"], ["proof (prove)\nusing this:\n  invar kdt\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p kdt)) p \\<le> dist (last ps) p", "proof (induction kdt arbitrary: ps)"], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "case (Node k v l r)"], ["proof (state)\nthis:\n  \\<lbrakk>invar l; sorted_wrt_dist p ?ps; n \\<le> length ?ps;\n   0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ?ps p l)) p\n                    \\<le> dist (last ?ps) p\n  \\<lbrakk>invar r; sorted_wrt_dist p ?ps; n \\<le> length ?ps;\n   0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ?ps p r)) p\n                    \\<le> dist (last ?ps) p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "let ?nnsl = \"nearest_nbors n ps p l\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "let ?nnsr = \"nearest_nbors n ps p r\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "have \"n \\<le> length ?nnsl\" \"n \\<le> length ?nnsr\""], ["proof (prove)\ngoal (1 subgoal):\n 1. n \\<le> length (nearest_nbors n ps p l) &&&\n    n \\<le> length (nearest_nbors n ps p r)", "using Node.prems(3)"], ["proof (prove)\nusing this:\n  n \\<le> length ps\n\ngoal (1 subgoal):\n 1. n \\<le> length (nearest_nbors n ps p l) &&&\n    n \\<le> length (nearest_nbors n ps p r)", "by (simp_all add: length_nns)"], ["proof (state)\nthis:\n  n \\<le> length (nearest_nbors n ps p l)\n  n \\<le> length (nearest_nbors n ps p r)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "hence \"dist (last (nearest_nbors n ?nnsl p r)) p \\<le> dist (last ?nnsl) p\"\n        \"dist (last (nearest_nbors n ?nnsr p l)) p \\<le> dist (last ?nnsr) p\""], ["proof (prove)\nusing this:\n  n \\<le> length (nearest_nbors n ps p l)\n  n \\<le> length (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last (nearest_nbors n ps p l)) p &&&\n    dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last (nearest_nbors n ps p r)) p", "using sorted_nns Node invar_l invar_r"], ["proof (prove)\nusing this:\n  n \\<le> length (nearest_nbors n ps p l)\n  n \\<le> length (nearest_nbors n ps p r)\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (nearest_nbors ?n ?ps ?p ?kdt)\n  \\<lbrakk>invar l; sorted_wrt_dist p ?ps; n \\<le> length ?ps;\n   0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ?ps p l)) p\n                    \\<le> dist (last ?ps) p\n  \\<lbrakk>invar r; sorted_wrt_dist p ?ps; n \\<le> length ?ps;\n   0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ?ps p r)) p\n                    \\<le> dist (last ?ps) p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last (nearest_nbors n ps p l)) p &&&\n    dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last (nearest_nbors n ps p r)) p", "by blast+"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "hence \"dist (last (nearest_nbors n ?nnsl p r)) p \\<le> dist (last ps) p\"\n        \"dist (last (nearest_nbors n ?nnsr p l)) p \\<le> dist (last ps) p\""], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last ps) p &&&\n    dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last ps) p", "using Node.IH(1)[of ps] Node.IH(2)[of ps] Node.prems invar_l length_nns_gt_0"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n  \\<lbrakk>invar l; sorted_wrt_dist p ps; n \\<le> length ps; 0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ps p l)) p\n                    \\<le> dist (last ps) p\n  \\<lbrakk>invar r; sorted_wrt_dist p ps; n \\<le> length ps; 0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ps p r)) p\n                    \\<le> dist (last ps) p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  0 < ?n \\<Longrightarrow> 0 < length (nearest_nbors ?n ?ps ?p ?kdt)\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last ps) p &&&\n    dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last ps) p", "by auto"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last ps) p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last ps) p\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    n \\<le> length ps; 0 < n\\<rbrakk>\n                   \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt1))\np\n                                     \\<le> dist (last ps) p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps; n \\<le> length ps;\n            0 < n\\<rbrakk>\n           \\<Longrightarrow> dist (last (nearest_nbors n ps p kdt2)) p\n                             \\<le> dist (last ps) p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        n \\<le> length ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> dist\n                          (last\n                            (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)))\n                          p\n                         \\<le> dist (last ps) p", "thus ?case"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last ps) p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last ps) p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p (Node k v l r))) p\n    \\<le> dist (last ps) p", "using Node"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last ps) p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last ps) p\n  \\<lbrakk>invar l; sorted_wrt_dist p ?ps; n \\<le> length ?ps;\n   0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ?ps p l)) p\n                    \\<le> dist (last ?ps) p\n  \\<lbrakk>invar r; sorted_wrt_dist p ?ps; n \\<le> length ?ps;\n   0 < n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors n ?ps p r)) p\n                    \\<le> dist (last ?ps) p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  n \\<le> length ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p (Node k v l r))) p\n    \\<le> dist (last ps) p", "by (auto simp add: Let_def)"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist (last ps) p\n\ngoal (1 subgoal):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps; n \\<le> length ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> dist (last (nearest_nbors n ps p (Leaf x))) p\n                         \\<le> dist (last ps) p", "qed (auto simp: sorted_wrt_dist_last_upd_nbors_mono)"], ["", "theorem dist_nns:\n  assumes \"invar kdt\" \"sorted_wrt_dist p ps\" \"set ps \\<inter> set_kdt kdt = {}\" \"distinct ps\" \"0 < n\"\n  shows \"\\<forall>q \\<in> set_kdt kdt \\<union> set ps - set (nearest_nbors n ps p kdt). dist (last (nearest_nbors n ps p kdt)) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt \\<union> set ps -\n                   set (nearest_nbors n ps p kdt).\n       dist (last (nearest_nbors n ps p kdt)) p \\<le> dist q p", "using assms"], ["proof (prove)\nusing this:\n  invar kdt\n  sorted_wrt_dist p ps\n  set ps \\<inter> set_kdt kdt = {}\n  distinct ps\n  0 < n\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt \\<union> set ps -\n                   set (nearest_nbors n ps p kdt).\n       dist (last (nearest_nbors n ps p kdt)) p \\<le> dist q p", "proof (induction kdt arbitrary: ps)"], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "case (Node k v l r)"], ["proof (state)\nthis:\n  \\<lbrakk>invar l; sorted_wrt_dist p ?ps; set ?ps \\<inter> set_kdt l = {};\n   distinct ?ps; 0 < n\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt l \\<union> set ?ps -\n                                   set (nearest_nbors n ?ps p l).\n                       dist (last (nearest_nbors n ?ps p l)) p\n                       \\<le> dist q p\n  \\<lbrakk>invar r; sorted_wrt_dist p ?ps; set ?ps \\<inter> set_kdt r = {};\n   distinct ?ps; 0 < n\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt r \\<union> set ?ps -\n                                   set (nearest_nbors n ?ps p r).\n                       dist (last (nearest_nbors n ?ps p r)) p\n                       \\<le> dist q p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  distinct ps\n  0 < n\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "let ?nnsl = \"nearest_nbors n ps p l\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "let ?nnsr = \"nearest_nbors n ps p r\""], ["proof (state)\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "have IHL: \"\\<forall>q \\<in> set_kdt l \\<union> set ps - set ?nnsl. dist (last ?nnsl) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l \\<union> set ps - set (nearest_nbors n ps p l).\n       dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "using Node.IH(1) Node.prems invar_l invar_set"], ["proof (prove)\nusing this:\n  \\<lbrakk>invar l; sorted_wrt_dist p ?ps; set ?ps \\<inter> set_kdt l = {};\n   distinct ?ps; 0 < n\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt l \\<union> set ?ps -\n                                   set (nearest_nbors n ?ps p l).\n                       dist (last (nearest_nbors n ?ps p l)) p\n                       \\<le> dist q p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  distinct ps\n  0 < n\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  set_kdt (Node ?k ?v ?l ?r) = set_kdt ?l \\<union> set_kdt ?r\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l \\<union> set ps - set (nearest_nbors n ps p l).\n       dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt l \\<union> set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "have IHR: \"\\<forall>q \\<in> set_kdt r \\<union> set ps - set ?nnsr. dist (last ?nnsr) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r \\<union> set ps - set (nearest_nbors n ps p r).\n       dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "using Node.IH(2) Node.prems invar_r invar_set"], ["proof (prove)\nusing this:\n  \\<lbrakk>invar r; sorted_wrt_dist p ?ps; set ?ps \\<inter> set_kdt r = {};\n   distinct ?ps; 0 < n\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt r \\<union> set ?ps -\n                                   set (nearest_nbors n ?ps p r).\n                       dist (last (nearest_nbors n ?ps p r)) p\n                       \\<le> dist q p\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  distinct ps\n  0 < n\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n  set_kdt (Node ?k ?v ?l ?r) = set_kdt ?l \\<union> set_kdt ?r\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r \\<union> set ps - set (nearest_nbors n ps p r).\n       dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt r \\<union> set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "have SORTED_L: \"sorted_wrt_dist p ?nnsl\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (nearest_nbors n ps p l)", "using sorted_nns Node.prems(2)"], ["proof (prove)\nusing this:\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (nearest_nbors ?n ?ps ?p ?kdt)\n  sorted_wrt_dist p ps\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (nearest_nbors n ps p l)", "by blast"], ["proof (state)\nthis:\n  sorted_wrt_dist p (nearest_nbors n ps p l)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "have SORTED_R: \"sorted_wrt_dist p ?nnsr\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (nearest_nbors n ps p r)", "using sorted_nns Node.prems(2)"], ["proof (prove)\nusing this:\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (nearest_nbors ?n ?ps ?p ?kdt)\n  sorted_wrt_dist p ps\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (nearest_nbors n ps p r)", "by blast"], ["proof (state)\nthis:\n  sorted_wrt_dist p (nearest_nbors n ps p r)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "have DISTINCT_L: \"distinct ?nnsl\""], ["proof (prove)\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p l)", "using Node.prems distinct_nns invar_set invar_l"], ["proof (prove)\nusing this:\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  distinct ps\n  0 < n\n  \\<lbrakk>invar ?kdt; distinct ?ps;\n   set ?ps \\<inter> set_kdt ?kdt = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors ?n ?ps ?p ?kdt)\n  set_kdt (Node ?k ?v ?l ?r) = set_kdt ?l \\<union> set_kdt ?r\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p l)", "by fastforce"], ["proof (state)\nthis:\n  distinct (nearest_nbors n ps p l)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "have DISTINCT_R: \"distinct ?nnsr\""], ["proof (prove)\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p r)", "using Node.prems distinct_nns invar_set invar_r"], ["proof (prove)\nusing this:\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n  distinct ps\n  0 < n\n  \\<lbrakk>invar ?kdt; distinct ?ps;\n   set ?ps \\<inter> set_kdt ?kdt = {}\\<rbrakk>\n  \\<Longrightarrow> distinct (nearest_nbors ?n ?ps ?p ?kdt)\n  set_kdt (Node ?k ?v ?l ?r) = set_kdt ?l \\<union> set_kdt ?r\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n\ngoal (1 subgoal):\n 1. distinct (nearest_nbors n ps p r)", "by (metis inf_bot_right inf_sup_absorb inf_sup_aci(3) sup.commute)"], ["proof (state)\nthis:\n  distinct (nearest_nbors n ps p r)\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "consider (A) \"p$k \\<le> v \\<and> length ?nnsl = n \\<and> dist p (last ?nnsl) \\<le> dist v (p$k)\"\n         | (B) \"p$k \\<le> v \\<and> \\<not>(length ?nnsl = n \\<and> dist p (last ?nnsl) \\<le> dist v (p$k))\"\n         | (C) \"v < p$k \\<and> length ?nnsr = n \\<and> dist p (last ?nnsr) \\<le> dist v (p$k)\"\n         | (D) \"v < p$k \\<and> \\<not>(length ?nnsr = n \\<and> dist p (last ?nnsr) \\<le> dist v (p$k))\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<lbrakk>p $ k \\<le> v \\<and>\n             length (nearest_nbors n ps p l) = n \\<and>\n             dist p (last (nearest_nbors n ps p l))\n             \\<le> dist v (p $ k) \\<Longrightarrow>\n             thesis;\n     p $ k \\<le> v \\<and>\n     \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n             dist p (last (nearest_nbors n ps p l))\n             \\<le> dist v (p $ k)) \\<Longrightarrow>\n     thesis;\n     v < p $ k \\<and>\n     length (nearest_nbors n ps p r) = n \\<and>\n     dist p (last (nearest_nbors n ps p r))\n     \\<le> dist v (p $ k) \\<Longrightarrow>\n     thesis;\n     v < p $ k \\<and>\n     \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n             dist p (last (nearest_nbors n ps p r))\n             \\<le> dist v (p $ k)) \\<Longrightarrow>\n     thesis\\<rbrakk>\n    \\<Longrightarrow> thesis", "by argo"], ["proof (state)\nthis:\n  \\<lbrakk>p $ k \\<le> v \\<and>\n           length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k) \\<Longrightarrow>\n           ?thesis;\n   p $ k \\<le> v \\<and>\n   \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   length (nearest_nbors n ps p r) = n \\<and>\n   dist p (last (nearest_nbors n ps p r))\n   \\<le> dist v (p $ k) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n           dist p (last (nearest_nbors n ps p r))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis\\<rbrakk>\n  \\<Longrightarrow> ?thesis\n\ngoal (2 subgoals):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p\n 2. \\<And>x1a x2 kdt1 kdt2 ps.\n       \\<lbrakk>\\<And>ps.\n                   \\<lbrakk>invar kdt1; sorted_wrt_dist p ps;\n                    set ps \\<inter> set_kdt kdt1 = {}; distinct ps;\n                    0 < n\\<rbrakk>\n                   \\<Longrightarrow> \\<forall>q\n        \\<in>set_kdt kdt1 \\<union> set ps - set (nearest_nbors n ps p kdt1).\n  dist (last (nearest_nbors n ps p kdt1)) p \\<le> dist q p;\n        \\<And>ps.\n           \\<lbrakk>invar kdt2; sorted_wrt_dist p ps;\n            set ps \\<inter> set_kdt kdt2 = {}; distinct ps; 0 < n\\<rbrakk>\n           \\<Longrightarrow> \\<forall>q\n\\<in>set_kdt kdt2 \\<union> set ps - set (nearest_nbors n ps p kdt2).\n                                dist (last (nearest_nbors n ps p kdt2)) p\n                                \\<le> dist q p;\n        invar (Node x1a x2 kdt1 kdt2); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Node x1a x2 kdt1 kdt2) = {}; distinct ps;\n        0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt\n   (Node x1a x2 kdt1 kdt2) \\<union>\n  set ps -\n  set (nearest_nbors n ps p (Node x1a x2 kdt1 kdt2)).\n                            dist\n                             (last\n                               (nearest_nbors n ps p\n                                 (Node x1a x2 kdt1 kdt2)))\n                             p\n                            \\<le> dist q p", "thus ?case"], ["proof (prove)\nusing this:\n  \\<lbrakk>p $ k \\<le> v \\<and>\n           length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k) \\<Longrightarrow>\n           ?thesis;\n   p $ k \\<le> v \\<and>\n   \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n           dist p (last (nearest_nbors n ps p l))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   length (nearest_nbors n ps p r) = n \\<and>\n   dist p (last (nearest_nbors n ps p r))\n   \\<le> dist v (p $ k) \\<Longrightarrow>\n   ?thesis;\n   v < p $ k \\<and>\n   \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n           dist p (last (nearest_nbors n ps p r))\n           \\<le> dist v (p $ k)) \\<Longrightarrow>\n   ?thesis\\<rbrakk>\n  \\<Longrightarrow> ?thesis\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "proof cases"], ["proof (state)\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "case A"], ["proof (state)\nthis:\n  p $ k \\<le> v \\<and>\n  length (nearest_nbors n ps p l) = n \\<and>\n  dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k)\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence \"\\<forall>q \\<in> set_kdt r. dist (last ?nnsl) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  p $ k \\<le> v \\<and>\n  length (nearest_nbors n ps p l) = n \\<and>\n  dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r.\n       dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "using Node.prems(1,2) cutoff_r"], ["proof (prove)\nusing this:\n  p $ k \\<le> v \\<and>\n  length (nearest_nbors n ps p l) = n \\<and>\n  dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k)\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  \\<lbrakk>invar (Node ?k ?v ?l ?r); ?p $ ?k \\<le> ?v;\n   dist ?p ?c \\<le> dist (?p $ ?k) ?v\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt ?r. dist ?p ?c \\<le> dist ?p q\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r.\n       dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "by (metis dist_commute)"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt r.\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (4 subgoals):\n 1. p $ k \\<le> v \\<and>\n    length (nearest_nbors n ps p l) = n \\<and>\n    dist p (last (nearest_nbors n ps p l))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 4. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "thus ?thesis"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt r.\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "using IHL A"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt r.\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n  \\<forall>q\\<in>set_kdt l \\<union> set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n  p $ k \\<le> v \\<and>\n  length (nearest_nbors n ps p l) = n \\<and>\n  dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                 set (nearest_nbors n ps p (Node k v l r)).\n     dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "next"], ["proof (state)\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "case B"], ["proof (state)\nthis:\n  p $ k \\<le> v \\<and>\n  \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n          dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k))\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "let ?nns = \"nearest_nbors n ?nnsl p r\""], ["proof (state)\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "have \"set ?nnsl \\<subseteq> set_kdt l \\<union> set ps\" \"set ps \\<inter> set_kdt r = {}\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p l) \\<subseteq> set_kdt l \\<union> set ps &&&\n    set ps \\<inter> set_kdt r = {}", "using set_nns Node.prems(1,3)"], ["proof (prove)\nusing this:\n  set (nearest_nbors ?n ?ps ?p ?kdt)\n  \\<subseteq> set_kdt ?kdt \\<union> set ?ps\n  invar (Node k v l r)\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p l) \\<subseteq> set_kdt l \\<union> set ps &&&\n    set ps \\<inter> set_kdt r = {}", "by (simp add: set_nns disjoint_iff_not_equal)+"], ["proof (state)\nthis:\n  set (nearest_nbors n ps p l) \\<subseteq> set_kdt l \\<union> set ps\n  set ps \\<inter> set_kdt r = {}\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence \"set ?nnsl \\<inter> set_kdt r = {}\""], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p l) \\<subseteq> set_kdt l \\<union> set ps\n  set ps \\<inter> set_kdt r = {}\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}", "using Node.prems(1)"], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p l) \\<subseteq> set_kdt l \\<union> set ps\n  set ps \\<inter> set_kdt r = {}\n  invar (Node k v l r)\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}", "by fastforce"], ["proof (state)\nthis:\n  set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence IHLR: \"\\<forall>q \\<in> set_kdt r \\<union> set ?nnsl - set ?nns. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r \\<union> set (nearest_nbors n ps p l) -\n                   set (nearest_nbors n (nearest_nbors n ps p l) p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "using Node.IH(2)[OF _ SORTED_L _ DISTINCT_L Node.prems(5)] Node.prems(1) invar_r"], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\n  \\<lbrakk>invar r;\n   set (nearest_nbors n ps p l) \\<inter> set_kdt r = {}\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt r \\<union>\n                                   set (nearest_nbors n ps p l) -\n                                   set (nearest_nbors n\n   (nearest_nbors n ps p l) p r).\n                       dist\n                        (last\n                          (nearest_nbors n (nearest_nbors n ps p l) p r))\n                        p\n                       \\<le> dist q p\n  invar (Node k v l r)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r \\<union> set (nearest_nbors n ps p l) -\n                   set (nearest_nbors n (nearest_nbors n ps p l) p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt r \\<union> set (nearest_nbors n ps p l) -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "have \"\\<forall>q \\<in> set ps - set ?nnsl. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps - set (nearest_nbors n ps p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "proof standard"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "fix q"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "assume *: \"q \\<in> set ps - set ?nnsl\""], ["proof (state)\nthis:\n  q \\<in> set ps - set (nearest_nbors n ps p l)\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "hence \"length ?nnsl = n\""], ["proof (prove)\nusing this:\n  q \\<in> set ps - set (nearest_nbors n ps p l)\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) = n", "using length_nns_n"], ["proof (prove)\nusing this:\n  q \\<in> set ps - set (nearest_nbors n ps p l)\n  set_kdt ?kdt \\<union> set ?ps -\n  set (nearest_nbors ?n ?ps ?p ?kdt) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors ?n ?ps ?p ?kdt) = ?n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) = n", "by blast"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p l) = n\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "hence LAST: \"dist (last ?nns) p \\<le> dist (last ?nnsl) p\""], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) = n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last (nearest_nbors n ps p l)) p", "using last_nns_mono SORTED_L invar_r Node.prems(1,2,5)"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) = n\n  \\<lbrakk>invar ?kdt; sorted_wrt_dist ?p ?ps; ?n \\<le> length ?ps;\n   0 < ?n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors ?n ?ps ?p ?kdt)) ?p\n                    \\<le> dist (last ?ps) ?p\n  sorted_wrt_dist p (nearest_nbors n ps p l)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last (nearest_nbors n ps p l)) p", "by (metis order_refl)"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "have \"dist (last ?nnsl) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "using IHL *"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt l \\<union> set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n  q \\<in> set ps - set (nearest_nbors n ps p l)\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "thus \"dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist q p", "using LAST"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist q p", "by argo"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist q p\n\ngoal:\nNo subgoals!", "qed"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence R: \"\\<forall>q \\<in> set_kdt r \\<union> set ps - set ?nns. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r \\<union> set ps -\n                   set (nearest_nbors n (nearest_nbors n ps p l) p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "using IHLR"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n  \\<forall>q\\<in>set_kdt r \\<union> set (nearest_nbors n ps p l) -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r \\<union> set ps -\n                   set (nearest_nbors n (nearest_nbors n ps p l) p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt r \\<union> set ps -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "have \"\\<forall>q \\<in> set_kdt l - set ?nnsl. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l - set (nearest_nbors n ps p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "proof standard"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt l - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "fix q"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt l - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "assume *: \"q \\<in> set_kdt l - set ?nnsl\""], ["proof (state)\nthis:\n  q \\<in> set_kdt l - set (nearest_nbors n ps p l)\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt l - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "hence \"length ?nnsl = n\""], ["proof (prove)\nusing this:\n  q \\<in> set_kdt l - set (nearest_nbors n ps p l)\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) = n", "using length_nns_n"], ["proof (prove)\nusing this:\n  q \\<in> set_kdt l - set (nearest_nbors n ps p l)\n  set_kdt ?kdt \\<union> set ?ps -\n  set (nearest_nbors ?n ?ps ?p ?kdt) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors ?n ?ps ?p ?kdt) = ?n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p l) = n", "by blast"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p l) = n\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt l - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "hence LAST: \"dist (last ?nns) p \\<le> dist (last ?nnsl) p\""], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) = n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last (nearest_nbors n ps p l)) p", "using last_nns_mono SORTED_L invar_r Node.prems(1,2,5)"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p l) = n\n  \\<lbrakk>invar ?kdt; sorted_wrt_dist ?p ?ps; ?n \\<le> length ?ps;\n   0 < ?n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors ?n ?ps ?p ?kdt)) ?p\n                    \\<le> dist (last ?ps) ?p\n  sorted_wrt_dist p (nearest_nbors n ps p l)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?r\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist (last (nearest_nbors n ps p l)) p", "by (metis order_refl)"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt l - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "have \"dist (last ?nnsl) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "using IHL *"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt l \\<union> set ps - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n  q \\<in> set_kdt l - set (nearest_nbors n ps p l)\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p l)) p \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt l - set (nearest_nbors n ps p l) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "thus \"dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist q p", "using LAST"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p l)) p \\<le> dist q p\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist (last (nearest_nbors n ps p l)) p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n    \\<le> dist q p", "by argo"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n  \\<le> dist q p\n\ngoal:\nNo subgoals!", "qed"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt l - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence L: \"\\<forall>q \\<in> set_kdt l - set ?nns. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt l - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l -\n                   set (nearest_nbors n (nearest_nbors n ps p l) p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "using IHLR"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt l - set (nearest_nbors n ps p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n  \\<forall>q\\<in>set_kdt r \\<union> set (nearest_nbors n ps p l) -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l -\n                   set (nearest_nbors n (nearest_nbors n ps p l) p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n       \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt l -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (3 subgoals):\n 1. p $ k \\<le> v \\<and>\n    \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n            dist p (last (nearest_nbors n ps p l))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 3. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "show ?thesis"], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "using B R L"], ["proof (prove)\nusing this:\n  p $ k \\<le> v \\<and>\n  \\<not> (length (nearest_nbors n ps p l) = n \\<and>\n          dist p (last (nearest_nbors n ps p l)) \\<le> dist v (p $ k))\n  \\<forall>q\\<in>set_kdt r \\<union> set ps -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n  \\<forall>q\\<in>set_kdt l -\n                 set (nearest_nbors n (nearest_nbors n ps p l) p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p l) p r)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                 set (nearest_nbors n ps p (Node k v l r)).\n     dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n\ngoal (2 subgoals):\n 1. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "next"], ["proof (state)\ngoal (2 subgoals):\n 1. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "case C"], ["proof (state)\nthis:\n  v < p $ k \\<and>\n  length (nearest_nbors n ps p r) = n \\<and>\n  dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k)\n\ngoal (2 subgoals):\n 1. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence \"\\<forall>q \\<in> set_kdt l. dist (last ?nnsr) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  v < p $ k \\<and>\n  length (nearest_nbors n ps p r) = n \\<and>\n  dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l.\n       dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "using Node.prems(1,2) cutoff_l"], ["proof (prove)\nusing this:\n  v < p $ k \\<and>\n  length (nearest_nbors n ps p r) = n \\<and>\n  dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k)\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  \\<lbrakk>invar (Node ?k ?v ?l ?r); ?v \\<le> ?p $ ?k;\n   dist ?p ?c \\<le> dist ?v (?p $ ?k)\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt ?l. dist ?p ?c \\<le> dist ?p q\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l.\n       dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "by (metis dist_commute less_imp_le)"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt l.\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (2 subgoals):\n 1. v < p $ k \\<and>\n    length (nearest_nbors n ps p r) = n \\<and>\n    dist p (last (nearest_nbors n ps p r))\n    \\<le> dist v (p $ k) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n 2. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "thus ?thesis"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt l.\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "using IHR C"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt l.\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n  \\<forall>q\\<in>set_kdt r \\<union> set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n  v < p $ k \\<and>\n  length (nearest_nbors n ps p r) = n \\<and>\n  dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k)\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                 set (nearest_nbors n ps p (Node k v l r)).\n     dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "next"], ["proof (state)\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "case D"], ["proof (state)\nthis:\n  v < p $ k \\<and>\n  \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n          dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k))\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "let ?nns = \"nearest_nbors n ?nnsr p l\""], ["proof (state)\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "have \"set ?nnsr \\<subseteq> set_kdt r \\<union> set ps\" \"set ps \\<inter> set_kdt l = {}\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p r) \\<subseteq> set_kdt r \\<union> set ps &&&\n    set ps \\<inter> set_kdt l = {}", "using set_nns Node.prems(1,3)"], ["proof (prove)\nusing this:\n  set (nearest_nbors ?n ?ps ?p ?kdt)\n  \\<subseteq> set_kdt ?kdt \\<union> set ?ps\n  invar (Node k v l r)\n  set ps \\<inter> set_kdt (Node k v l r) = {}\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p r) \\<subseteq> set_kdt r \\<union> set ps &&&\n    set ps \\<inter> set_kdt l = {}", "by (simp add: set_nns disjoint_iff_not_equal)+"], ["proof (state)\nthis:\n  set (nearest_nbors n ps p r) \\<subseteq> set_kdt r \\<union> set ps\n  set ps \\<inter> set_kdt l = {}\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence \"set ?nnsr \\<inter> set_kdt l = {}\""], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p r) \\<subseteq> set_kdt r \\<union> set ps\n  set ps \\<inter> set_kdt l = {}\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}", "using Node.prems(1)"], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p r) \\<subseteq> set_kdt r \\<union> set ps\n  set ps \\<inter> set_kdt l = {}\n  invar (Node k v l r)\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}", "by fastforce"], ["proof (state)\nthis:\n  set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence IHRL: \"\\<forall>q \\<in> set_kdt l \\<union> set ?nnsr - set ?nns. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l \\<union> set (nearest_nbors n ps p r) -\n                   set (nearest_nbors n (nearest_nbors n ps p r) p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "using Node.IH(1)[OF _ SORTED_R _ DISTINCT_R Node.prems(5)] Node.prems(1) invar_l"], ["proof (prove)\nusing this:\n  set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\n  \\<lbrakk>invar l;\n   set (nearest_nbors n ps p r) \\<inter> set_kdt l = {}\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt l \\<union>\n                                   set (nearest_nbors n ps p r) -\n                                   set (nearest_nbors n\n   (nearest_nbors n ps p r) p l).\n                       dist\n                        (last\n                          (nearest_nbors n (nearest_nbors n ps p r) p l))\n                        p\n                       \\<le> dist q p\n  invar (Node k v l r)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l \\<union> set (nearest_nbors n ps p r) -\n                   set (nearest_nbors n (nearest_nbors n ps p r) p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt l \\<union> set (nearest_nbors n ps p r) -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "have \"\\<forall>q \\<in> set ps - set ?nnsr. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set ps - set (nearest_nbors n ps p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "proof standard"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "fix q"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "assume *: \"q \\<in> set ps - set ?nnsr\""], ["proof (state)\nthis:\n  q \\<in> set ps - set (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "hence \"length ?nnsr = n\""], ["proof (prove)\nusing this:\n  q \\<in> set ps - set (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) = n", "using length_nns_n"], ["proof (prove)\nusing this:\n  q \\<in> set ps - set (nearest_nbors n ps p r)\n  set_kdt ?kdt \\<union> set ?ps -\n  set (nearest_nbors ?n ?ps ?p ?kdt) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors ?n ?ps ?p ?kdt) = ?n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) = n", "by blast"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p r) = n\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "hence LAST: \"dist (last ?nns) p \\<le> dist (last ?nnsr) p\""], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) = n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last (nearest_nbors n ps p r)) p", "using last_nns_mono SORTED_R invar_l Node.prems(1,2,5)"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) = n\n  \\<lbrakk>invar ?kdt; sorted_wrt_dist ?p ?ps; ?n \\<le> length ?ps;\n   0 < ?n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors ?n ?ps ?p ?kdt)) ?p\n                    \\<le> dist (last ?ps) ?p\n  sorted_wrt_dist p (nearest_nbors n ps p r)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last (nearest_nbors n ps p r)) p", "by (metis order_refl)"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "have \"dist (last ?nnsr) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "using IHR *"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt r \\<union> set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n  q \\<in> set ps - set (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set ps - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "thus \"dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist q p", "using LAST"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist q p", "by argo"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist q p\n\ngoal:\nNo subgoals!", "qed"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence R: \"\\<forall>q \\<in> set_kdt l \\<union> set ps - set ?nns. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l \\<union> set ps -\n                   set (nearest_nbors n (nearest_nbors n ps p r) p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "using IHRL"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n  \\<forall>q\\<in>set_kdt l \\<union> set (nearest_nbors n ps p r) -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt l \\<union> set ps -\n                   set (nearest_nbors n (nearest_nbors n ps p r) p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt l \\<union> set ps -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "have \"\\<forall>q \\<in> set_kdt r - set ?nnsr. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r - set (nearest_nbors n ps p r).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "proof standard"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt r - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "fix q"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt r - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "assume *: \"q \\<in> set_kdt r - set ?nnsr\""], ["proof (state)\nthis:\n  q \\<in> set_kdt r - set (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt r - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "hence \"length ?nnsr = n\""], ["proof (prove)\nusing this:\n  q \\<in> set_kdt r - set (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) = n", "using length_nns_n"], ["proof (prove)\nusing this:\n  q \\<in> set_kdt r - set (nearest_nbors n ps p r)\n  set_kdt ?kdt \\<union> set ?ps -\n  set (nearest_nbors ?n ?ps ?p ?kdt) \\<noteq>\n  {} \\<Longrightarrow>\n  length (nearest_nbors ?n ?ps ?p ?kdt) = ?n\n\ngoal (1 subgoal):\n 1. length (nearest_nbors n ps p r) = n", "by blast"], ["proof (state)\nthis:\n  length (nearest_nbors n ps p r) = n\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt r - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "hence LAST: \"dist (last ?nns) p \\<le> dist (last ?nnsr) p\""], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) = n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last (nearest_nbors n ps p r)) p", "using last_nns_mono SORTED_R invar_l Node.prems(1,2,5)"], ["proof (prove)\nusing this:\n  length (nearest_nbors n ps p r) = n\n  \\<lbrakk>invar ?kdt; sorted_wrt_dist ?p ?ps; ?n \\<le> length ?ps;\n   0 < ?n\\<rbrakk>\n  \\<Longrightarrow> dist (last (nearest_nbors ?n ?ps ?p ?kdt)) ?p\n                    \\<le> dist (last ?ps) ?p\n  sorted_wrt_dist p (nearest_nbors n ps p r)\n  invar (Node ?k ?v ?l ?r) \\<Longrightarrow> invar ?l\n  invar (Node k v l r)\n  sorted_wrt_dist p ps\n  0 < n\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist (last (nearest_nbors n ps p r)) p", "by (metis order_refl)"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt r - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "have \"dist (last ?nnsr) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "using IHR *"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt r \\<union> set ps - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n  q \\<in> set_kdt r - set (nearest_nbors n ps p r)\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n ps p r)) p \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<And>q.\n       q \\<in> set_kdt r - set (nearest_nbors n ps p r) \\<Longrightarrow>\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "thus \"dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist q p", "using LAST"], ["proof (prove)\nusing this:\n  dist (last (nearest_nbors n ps p r)) p \\<le> dist q p\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist (last (nearest_nbors n ps p r)) p\n\ngoal (1 subgoal):\n 1. dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n    \\<le> dist q p", "by argo"], ["proof (state)\nthis:\n  dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n  \\<le> dist q p\n\ngoal:\nNo subgoals!", "qed"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt r - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "hence L: \"\\<forall>q \\<in> set_kdt r - set ?nns. dist (last ?nns) p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt r - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r -\n                   set (nearest_nbors n (nearest_nbors n ps p r) p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "using IHRL"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt r - set (nearest_nbors n ps p r).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n  \\<forall>q\\<in>set_kdt l \\<union> set (nearest_nbors n ps p r) -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt r -\n                   set (nearest_nbors n (nearest_nbors n ps p r) p l).\n       dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n       \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt r -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. v < p $ k \\<and>\n    \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n            dist p (last (nearest_nbors n ps p r))\n            \\<le> dist v (p $ k)) \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "show ?thesis"], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "using D R L"], ["proof (prove)\nusing this:\n  v < p $ k \\<and>\n  \\<not> (length (nearest_nbors n ps p r) = n \\<and>\n          dist p (last (nearest_nbors n ps p r)) \\<le> dist v (p $ k))\n  \\<forall>q\\<in>set_kdt l \\<union> set ps -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n  \\<forall>q\\<in>set_kdt r -\n                 set (nearest_nbors n (nearest_nbors n ps p r) p l).\n     dist (last (nearest_nbors n (nearest_nbors n ps p r) p l)) p\n     \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                   set (nearest_nbors n ps p (Node k v l r)).\n       dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p", "by auto"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                 set (nearest_nbors n ps p (Node k v l r)).\n     dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n\ngoal:\nNo subgoals!", "qed"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt (Node k v l r) \\<union> set ps -\n                 set (nearest_nbors n ps p (Node k v l r)).\n     dist (last (nearest_nbors n ps p (Node k v l r))) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<And>x ps.\n       \\<lbrakk>invar (Leaf x); sorted_wrt_dist p ps;\n        set ps \\<inter> set_kdt (Leaf x) = {}; distinct ps; 0 < n\\<rbrakk>\n       \\<Longrightarrow> \\<forall>q\\<in>set_kdt (Leaf x) \\<union> set ps -\n  set (nearest_nbors n ps p (Leaf x)).\n                            dist (last (nearest_nbors n ps p (Leaf x))) p\n                            \\<le> dist q p", "qed (auto simp: sorted_wrt_dist_nbors_diff upd_nbors_def)"], ["", "subsection \\<open>Nearest Neighbors Definition and Theorems\\<close>"], ["", "definition nearest_neighbors :: \"nat \\<Rightarrow> ('k::finite) point \\<Rightarrow> 'k kdt \\<Rightarrow> 'k point list\" where\n  \"nearest_neighbors n p kdt = nearest_nbors n [] p kdt\""], ["", "theorem length_nearest_neighbors:\n  \"length (nearest_neighbors n p kdt) = min n (size_kdt kdt)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. length (nearest_neighbors n p kdt) = min n (KD_Tree.size_kdt kdt)", "by (simp add: length_nns nearest_neighbors_def)"], ["", "theorem sorted_wrt_dist_nearest_neighbors:\n  \"sorted_wrt_dist p (nearest_neighbors n p kdt)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (nearest_neighbors n p kdt)", "using sorted_nns"], ["proof (prove)\nusing this:\n  sorted_wrt_dist ?p ?ps \\<Longrightarrow>\n  sorted_wrt_dist ?p (nearest_nbors ?n ?ps ?p ?kdt)\n\ngoal (1 subgoal):\n 1. sorted_wrt_dist p (nearest_neighbors n p kdt)", "unfolding nearest_neighbors_def sorted_wrt_dist_def"], ["proof (prove)\nusing this:\n  sorted_wrt\n   (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 ?p \\<le> dist p\\<^sub>1 ?p)\n   ?ps \\<Longrightarrow>\n  sorted_wrt\n   (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 ?p \\<le> dist p\\<^sub>1 ?p)\n   (nearest_nbors ?n ?ps ?p ?kdt)\n\ngoal (1 subgoal):\n 1. sorted_wrt\n     (\\<lambda>p\\<^sub>0 p\\<^sub>1. dist p\\<^sub>0 p \\<le> dist p\\<^sub>1 p)\n     (nearest_nbors n [] p kdt)", "by force"], ["", "theorem set_nearest_neighbors:\n  \"set (nearest_neighbors n p kdt) \\<subseteq> set_kdt kdt\""], ["proof (prove)\ngoal (1 subgoal):\n 1. set (nearest_neighbors n p kdt) \\<subseteq> set_kdt kdt", "unfolding nearest_neighbors_def"], ["proof (prove)\ngoal (1 subgoal):\n 1. set (nearest_nbors n [] p kdt) \\<subseteq> set_kdt kdt", "using set_nns"], ["proof (prove)\nusing this:\n  set (nearest_nbors ?n ?ps ?p ?kdt)\n  \\<subseteq> set_kdt ?kdt \\<union> set ?ps\n\ngoal (1 subgoal):\n 1. set (nearest_nbors n [] p kdt) \\<subseteq> set_kdt kdt", "by force"], ["", "theorem distinct_nearest_neighbors:\n  assumes \"invar kdt\"\n  shows \"distinct (nearest_neighbors n p kdt)\""], ["proof (prove)\ngoal (1 subgoal):\n 1. distinct (nearest_neighbors n p kdt)", "using assms"], ["proof (prove)\nusing this:\n  invar kdt\n\ngoal (1 subgoal):\n 1. distinct (nearest_neighbors n p kdt)", "by (simp add: distinct_nns nearest_neighbors_def)"], ["", "theorem dist_nearest_neighbors:\n  assumes \"invar kdt\" \"nns = nearest_neighbors n p kdt\"\n  shows \"\\<forall>q \\<in> (set_kdt kdt - set nns). \\<forall>r \\<in> set nns. dist r p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "proof (cases \"0 < n\")"], ["proof (state)\ngoal (2 subgoals):\n 1. 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p\n 2. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "case True"], ["proof (state)\nthis:\n  0 < n\n\ngoal (2 subgoals):\n 1. 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p\n 2. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "have \"\\<forall>q \\<in> set_kdt kdt - set nns. dist (last nns) p \\<le> dist q p\""], ["proof (prove)\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns. dist (last nns) p \\<le> dist q p", "using nearest_neighbors_def dist_nns[OF assms(1), of p \"[]\", OF _ _ _ True] assms(2)"], ["proof (prove)\nusing this:\n  nearest_neighbors ?n ?p ?kdt = nearest_nbors ?n [] ?p ?kdt\n  \\<lbrakk>sorted_wrt_dist p []; set [] \\<inter> set_kdt kdt = {};\n   distinct []\\<rbrakk>\n  \\<Longrightarrow> \\<forall>q\\<in>set_kdt kdt \\<union> set [] -\n                                   set (nearest_nbors n [] p kdt).\n                       dist (last (nearest_nbors n [] p kdt)) p\n                       \\<le> dist q p\n  nns = nearest_neighbors n p kdt\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns. dist (last nns) p \\<le> dist q p", "by (simp add: nearest_neighbors_def sorted_wrt_dist_def)"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt kdt - set nns. dist (last nns) p \\<le> dist q p\n\ngoal (2 subgoals):\n 1. 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p\n 2. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "hence \"\\<forall>q \\<in> set_kdt kdt - set nns. \\<forall>n \\<in> set nns. dist n p \\<le> dist q p\""], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt kdt - set nns. dist (last nns) p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>n\\<in>set nns. dist n p \\<le> dist q p", "using assms(2) sorted_wrt_dist_nearest_neighbors[of p n kdt] sorted_wrt_dist_last[of p nns]"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt kdt - set nns. dist (last nns) p \\<le> dist q p\n  nns = nearest_neighbors n p kdt\n  sorted_wrt_dist p (nearest_neighbors n p kdt)\n  sorted_wrt_dist p nns \\<Longrightarrow>\n  \\<forall>q\\<in>set nns. dist q p \\<le> dist (last nns) p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>n\\<in>set nns. dist n p \\<le> dist q p", "by force"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt kdt - set nns.\n     \\<forall>n\\<in>set nns. dist n p \\<le> dist q p\n\ngoal (2 subgoals):\n 1. 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p\n 2. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "thus ?thesis"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt kdt - set nns.\n     \\<forall>n\\<in>set nns. dist n p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "using nearest_neighbors_def"], ["proof (prove)\nusing this:\n  \\<forall>q\\<in>set_kdt kdt - set nns.\n     \\<forall>n\\<in>set nns. dist n p \\<le> dist q p\n  nearest_neighbors ?n ?p ?kdt = nearest_nbors ?n [] ?p ?kdt\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "by blast"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt kdt - set nns.\n     \\<forall>r\\<in>set nns. dist r p \\<le> dist q p\n\ngoal (1 subgoal):\n 1. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "next"], ["proof (state)\ngoal (1 subgoal):\n 1. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "case False"], ["proof (state)\nthis:\n  \\<not> 0 < n\n\ngoal (1 subgoal):\n 1. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "hence \"length nns = 0\""], ["proof (prove)\nusing this:\n  \\<not> 0 < n\n\ngoal (1 subgoal):\n 1. length nns = 0", "using assms(2)"], ["proof (prove)\nusing this:\n  \\<not> 0 < n\n  nns = nearest_neighbors n p kdt\n\ngoal (1 subgoal):\n 1. length nns = 0", "unfolding nearest_neighbors_def"], ["proof (prove)\nusing this:\n  \\<not> 0 < n\n  nns = nearest_nbors n [] p kdt\n\ngoal (1 subgoal):\n 1. length nns = 0", "by (auto simp: length_nns)"], ["proof (state)\nthis:\n  length nns = 0\n\ngoal (1 subgoal):\n 1. \\<not> 0 < n \\<Longrightarrow>\n    \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "thus ?thesis"], ["proof (prove)\nusing this:\n  length nns = 0\n\ngoal (1 subgoal):\n 1. \\<forall>q\\<in>set_kdt kdt - set nns.\n       \\<forall>r\\<in>set nns. dist r p \\<le> dist q p", "by simp"], ["proof (state)\nthis:\n  \\<forall>q\\<in>set_kdt kdt - set nns.\n     \\<forall>r\\<in>set nns. dist r p \\<le> dist q p\n\ngoal:\nNo subgoals!", "qed"], ["", "end"]]}